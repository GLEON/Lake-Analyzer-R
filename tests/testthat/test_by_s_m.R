context("Testing by_s_m.")

library(limnotools)

#source("by_s_m_results.R") # Get results from Fortran test.
#load("../../data/t11.rda")   # Same data as Fortran test

## Load results from Fortran Code
DensityResults = list(
  variable="Density",
  thres=   5.0000000000000001E-003 ,
  result=   10.238362499999997      ,
  nimax=          11 ,
  smz=c(
    3.0139999999999998      ,
    10.238362499999997      ,
    11.768227500000002      ,
    16.357822500000015      ,
    19.927507500000022      ,
    27.746817500000049      ,
    32.166427500000054      ,
    45.085287499999829      ,
    81.292092499999171      ,
    103.05017249999878      ,
    115.11910749999856      ,
    138.74702249999814     
  ),
  sms=c(
    22.175300000000000      ,
    22.182955192507805      ,
    22.245220865384617      ,
    23.798331079868159      ,
    24.136031837230139      ,
    24.582305998466264      ,
    24.799138957828283      ,
    24.945131564356430      ,
    25.458473610728344      ,
    25.867523759172386      ,
    26.099403494723610      ,
    26.246935248742442     
  )
)

TemperatureResults = list(
  variable="Temperature",
  thres=   5.0000000000000001E-003 ,
  result=   10.238362499999997      ,
  nimax=          19 ,
  smz=c(
    3.0139999999999998      ,
    10.238362499999997      ,
    12.788137500000005      ,
    16.357822500000015      ,
    24.517102500000036      ,
    28.596742500000051      ,
    32.846367500000042      ,
    36.926007499999969      ,
    47.295092499999775      ,
    59.024057499999579      ,
    62.253772499999521      ,
    72.282887499999333      ,
    77.212452499999245      ,
    78.912302499999228      ,
    87.241567499999064      ,
    96.930712499998890      ,
    103.56012749999876      ,
    115.62906249999855      ,
    125.31820749999838      ,
    138.74702249999814     
  ),
  sms=c(
    17.536700000000000      ,
    17.507852194328827      ,
    17.018911273726275      ,
    15.252638800202835      ,
    13.058652764496433      ,
    11.840608646249979      ,
    11.082079836363633      ,
    10.689752586785012      ,
    10.221020356281414      ,
    9.3946439637650379      ,
    9.1708952128412964      ,
    8.6472368070519376      ,
    8.8060496147624008      ,
    8.7221997073422290      ,
    8.8347013397177321      ,
    8.7524852111917415      ,
    8.8484104603567992      ,
    8.4574091457286595      ,
    8.3603630876088957      ,
    8.2075126184607612     
  )
)

SalinityResults = list(
  variable="Salinity",
  thres=   5.0000000000000001E-003 ,
  result=   11.428257500000001      ,
  nimax=          16 ,
  smz=c(
    3.0139999999999998      ,
    11.428257500000001      ,
    16.527807500000016      ,
    17.717702500000019      ,
    20.437462500000027      ,
    29.786637500000051      ,
    42.705497499999865      ,
    67.183337499999425      ,
    74.662677499999305      ,
    77.722407499999235      ,
    82.312002499999153      ,
    85.201747499999101      ,
    93.021057499998960      ,
    102.37023249999879      ,
    111.88939249999864      ,
    121.57853749999845      ,
    138.74702249999814     
  ),
  sms=c(
    30.774300000000000      ,
    30.788757116902833      ,
    32.235080587981741      ,
    32.282705613202815      ,
    32.352829153185041      ,
    32.454949022007916      ,
    32.460603141194333      ,
    32.534835672705306      ,
    32.642183068710338      ,
    32.719751271739128      ,
    32.806572846019897      ,
    32.896363621189749      ,
    33.076093626130799      ,
    33.338829524703556      ,
    33.520213286910952      ,
    33.603794355797817      ,
    33.698596563883285     
  )
)

error = function(veca, vecb) {
  sqrt(sum( (veca-vecb)^2 ))
}

maxerror = 1.e-6

test_that("Run, compare density results with Fortran.", {
  # by_s_m = function(thres,z0,zmax,z,sigma)
  results = by_s_m( thres=.005, z0=2.5,zmax=140, z=t11$depth, sigma=t11$density)
  # results = list(nimax=nimax,smz=smz,sms=sms,by_s_m=ss)

  expect_equal( results$nimax, DensityResults$nimax )
  expect_equal( results$by_s_m, DensityResults$result )

  expect_lt( error(results$smz,DensityResults$smz), maxerror )
  expect_lt( error(results$sms,DensityResults$sms), maxerror )
})

test_that("Run, compare temperature results with Fortran.", {
  # by_s_m = function(thres,z0,zmax,z,sigma)
  results = by_s_m( thres=.005, z0=2.5,zmax=140, z=t11$depth, sigma=t11$temper)
  # results = list(nimax=nimax,smz=smz,sms=sms,by_s_m=ss)

  expect_equal( results$nimax, TemperatureResults$nimax )
  expect_equal( results$by_s_m, TemperatureResults$result )

  expect_lt( error(results$smz,TemperatureResults$smz), maxerror )
  expect_lt( error(results$sms,TemperatureResults$sms), maxerror )
})

test_that("Run, compare salinity results with Fortran.", {
  # by_s_m = function(thres,z0,zmax,z,sigma)
  results = by_s_m( thres=.005, z0=2.5,zmax=140, z=t11$depth, sigma=t11$salinity)
  # results = list(nimax=nimax,smz=smz,sms=sms,by_s_m=ss)

  expect_equal( results$nimax, SalinityResults$nimax )
  expect_equal( results$by_s_m, SalinityResults$result )

  expect_lt( error(results$smz,SalinityResults$smz), maxerror )
  expect_lt( error(results$sms,SalinityResults$sms), maxerror )
})
